---
title: Mapa del coronavirus en el Ecuador
authors: 
  - Alonso Quijano
date: '2020-03-22'
categories:
  - Salud
tags:
  - Coronavirus
  - Mapas
---

```{r, echo=TRUE, warning=FALSE, message=FALSE, comment=FALSE}
# --------- these are the packages used to create the map ---------
library(RCurl)
library(tidyverse)
library(sf)
library(rmapshaper)
library(tmap)
library(leaflet)

# --------- Download the shapefile and the coronavirus csv data from github ---------
# The coronavirus data ----
url <- "https://raw.githubusercontent.com/aquijanoruiz/elquantificador_posts/master/salud/2020-03-22-mapa-del-coronavirus-en-el-ecuador/covid19_confirmed.csv"
confirmed <- read_csv(url) # Now we have loaded the coronavirus file

# Ecuador's political division (*.shp) data ----
url <- "https://github.com/aquijanoruiz/elquantificador_posts/raw/master/salud/2020-03-22-mapa-del-coronavirus-en-el-ecuador/ECU_adm1.zip"
td <- tempdir() # We create a temporary directory
tf <- tempfile(tmpdir=td, fileext = ".zip") # We create the placeholder file
download.file(url,tf) # We download the data into the placeholder file

# We get the name of the file inside the zip file that contains the demographic and economic data, 
# unzip it, get the full path name of it, and finally load it
shp.file.name <- unzip(tf, list=TRUE)$Name[4] # The shp file name
shx.file.name <- unzip(tf, list=TRUE)$Name[6] # The shx file name
dbf.fine.name <- unzip(tf, list=TRUE)$Name[8] # The dbf file name
prf.fine.name <- unzip(tf, list=TRUE)$Name[10] # The prf file name

unzip(tf, files=c(shp.file.name, shx.file.name, dbf.fine.name, prf.fine.name), exdir=td, overwrite=TRUE)
shp.file.path <- file.path(td, shp.file.name)

ecu_map <- st_read(shp.file.path) # Now we have loaded the shapefile
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, comment=FALSE}
# --------- Simplifying the map data ---------
ecu_map <- ms_simplify(ecu_map, keep=0.01) # We keep the 0.4% of the polygon

# We keep only the variables we need
ecu_map <- ecu_map %>% select(-c(ID_0, ISO, NAME_0, ID_1, TYPE_1, ENGTYPE_1, NL_NAME_1, VARNAME_1)) %>%
  rename(Provincia = NAME_1) # We only keep the province names and the geometry

# --------- preparing the coronavirus data ---------
# We need to transform the data from wide to long
confirmed <- confirmed %>% gather(Fecha, Casos, -Provincia) %>% 
  mutate(Fecha = as.Date(Fecha, format = "%m/%d/%Y")) %>%
  filter(Fecha >= as.Date("2020-03-05")) %>% # We only have data by province from May 5th
  replace_na(list(Casos = 0))

confirmed$Provincia <- factor(confirmed$Provincia, levels = levels(ecu_map$Provincia)) # We want to keep the same levels between the two sets
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, comment=FALSE}
# --------- merging the st data with the coronavirus data ---------
centroid <- st_centroid(ecu_map)
centroid[23,] # We use Tungurahua province as the center of our map 

covid19_confirmed <- inner_join(ecu_map, confirmed, by = "Provincia") # We merge the map data with the coronavirus data

# We filter the date we want and take out the date column
today <- "2020-03-23" # We set the date we want the map to illustrate
covid19_confirmed_today <- covid19_confirmed %>% filter(Fecha == today) %>% select(-Fecha)

# --------- creating the map ---------
# We filter the data and take out the nonzero elements
covid19_nozeros <- covid19_confirmed_today[!covid19_confirmed_today$Casos == 0,]

covid19_confirmed_today_map <- covid19_confirmed_today %>%
  tm_shape() + tm_borders(col = "grey", lwd = 2, alpha = 0.4) +
  tm_polygons(col = "skyblue", alpha = 0.2) + 
  tm_shape(covid19_nozeros) + # We add a second tm_shape with the coronavirus data
  tm_bubbles(size = "Casos", col = "red", alpha = 0.6, scale = 4, border.lwd = NA)

covid19_confirmed_today_map <- tmap_leaflet(covid19_confirmed_today_map) # We transform the map into a leaflet map
```

Después que la OMS haya declarado pandemia al brote de Covid-19, el presidente del Ecuador, Lenín Moreno, declaró emergencia sanitaria a todo el país. A fin de lugar contra la propagación del coronavirus, es imporante permanecer en casa, obedeciendo a las medidas de prevención y manteniéndonos informados de cómo avanza la situación sanitaria. Te presentamos un mapa interactivo para que sigas día a día el número de casos confirmados de coronavirus en el país. El mapa está actualizado al `r today`.



<style>
.html-widget {
    margin: auto;
}
</style>

```{r, echo=TRUE, warning=FALSE, message=FALSE, fig.align = "center", fig.height = 7, fig.width = 6}
covid19_confirmed_today_map %>% removeLayersControl() %>%
  setView(lng = -78.50374, lat = -1.289527, zoom = 5) %>% fitBounds(-79.6, -4.2, -77.0, 0.8) # We center the map in Tungurahua
```

Fuente: Ministerio de Salud del Ecuador